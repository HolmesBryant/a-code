/**
 * @author Holmes Bryant <Holmes Bryant <https://github.com/HolmesBryant>
 * @version 2.0.0
 * @license GPL-3.0
 */
const t=new WeakMap;class ModelObserver{#t=new Map;subscribe(t,e){this.#t.has(t)||this.#t.set(t,new Set),this.#t.get(t).add(e)}unsubscribe(t,e){if(this.#t.has(t)){const i=this.#t.get(t);i.delete(e),0===i.size&&this.#t.delete(t)}}publish(t,e){this.#t.has(t)&&this.#t.get(t).forEach((t=>t(e)))}}const e=new class{#e=new Map;#i=!1;scheduleUpdate(t,e){this.#e.set(t,e),this.#i||(this.#i=!0,requestAnimationFrame((()=>this.#s())))}#s(){this.#e.forEach(((t,e)=>{e.isConnected&&e.applyUpdate(t)})),this.#e.clear(),this.#i=!1}};class ABind extends HTMLElement{#r=!1;#l="value";#n="input";#o=null;#d=null;#u=null;#h=!1;#a=null;#c=!1;#p=!1;#m=150;#b;#f;#g=!1;#y=!1;#A=null;#v=null;#w=null;#O=null;#E=null;#C=0;#B=null;static observedAttributes=["debug","elem-attr","event","func","model","model-attr","once","property","pull","push","throttle"];constructor(){super()}attributeChangedCallback(t,e,i){e!==i&&(this.#U(t,i),this.isConnected&&["model","property","model-attr"].includes(t)&&this.#T())}connectedCallback(){this.#r&&console.debug("Debugging:",this),window.abind||(window.abind=ABind),this.firstElementChild?this.#k():(this.#w=new MutationObserver((()=>{this.firstElementChild&&(this.#w.disconnect(),this.#w=null,this.#k())})),this.#w.observe(this,{childList:!0}))}disconnectedCallback(){this.#M(),this.#w&&(this.#w.disconnect(),this.#w=null)}static update(t,e,i){const s=ABind.#j(t,!0);s?s.publish(e,i):console.warn("a-bind: Invalid model for update",t)}static updateDefer(t,e,i=0){setTimeout((()=>{const i=ABind.#P(t,e);ABind.update(t,e,i)}),i)}applyUpdate(t){this.#R(t)}#z(t){const e=this.#o.split("."),i=e.pop(),s=e.join(".");let r=s?ABind.#P(this.#d,s):this.#d;r&&"function"==typeof r[i]||(r=s?ABind.#P(window,s):window),r&&"function"==typeof r[i]?r[i].call(r,t):this.#r&&console.warn(`a-bind: Function ${this.#o} not found.`)}#I(t){if(this.#o&&this.#z(t),this.#c||!this.#a&&!this.#u)return;let e;const i=this.#f;e="select"===i.localName&&i.multiple?Array.from(i.selectedOptions).map((t=>t.value)):"checkbox"===i.type?i.checked?i.getAttribute("value")||!0:!!i.getAttribute("value")&&null:void 0!==t.target.value?t.target.value:i[this.#l],this.#m>0?(this.#O&&clearTimeout(this.#O),this.#O=setTimeout((()=>{this.#L(e),this.#O=null}),this.#m)):this.#L(e)}async#k(){if(!this.#y){this.#y=!0;try{if(!this.#d)return void(this.#y=!1);if(await this.#q(),!this.firstElementChild)return void(this.#y=!1);let t=this.firstElementChild;for(;t&&"a-bind"===t.localName;)t=t.firstElementChild;if(this.#f=t,!this.#f)return console.warn("a-bind: No valid child element to bind to."),void(this.#y=!1);this.#b=new AbortController,this.#x(),this.#R()}catch(t){console.error("a-bind initialization error:",t,this)}finally{this.#y=!1}}}#T(){this.#M(),this.#k()}async#q(){if("object"==typeof this.#d&&null!==this.#d)return;const t=this.#d;if("string"==typeof t){const e=document.querySelector(t);if(e)return e.localName.includes("-")&&await customElements.whenDefined(e.localName),void(this.#d=e);const i=ABind.#P(window,t);if(i)return void(this.#d=i)}this.#r&&console.warn("a-bind: Model not resolved:",t)}#N(t,e,i){if(null==i&&(i=""),e.startsWith("style."))t.style[e.split(".")[1]]=i;else if("input"!==t.localName||"checkbox"!==t.type&&"radio"!==t.type)if("select"===t.localName&&t.multiple){const e=Array.isArray(i)?i.map(String):String(i).split(",");Array.from(t.options).forEach((t=>t.selected=e.includes(t.value)))}else e in t?t[e]=i:t.setAttribute(e,i);else t.checked=String(t.value)===String(i)||!0===i}#S(t,e,i){const s=e.split("."),r=s.pop(),l=s.length?ABind.#P(t,s.join(".")):t;l&&"object"==typeof l&&(l[r]=i)}#x(){if(!this.#a&&!this.#o&&!this.#u)return;this.#n&&this.#f.addEventListener(this.#n,(t=>this.#I(t)),{signal:this.#b.signal});const t=ABind.#j(this.#d,!0);this.#v=this.#a||this.#u,t&&this.#v&&(this.#A=t=>{if(!this.#h||!this.#g)if(this.#m>0){const i=Date.now(),s=i-this.#C;if(s>=this.#m)this.#C=i,e.scheduleUpdate(this,t);else if(this.#B=t,!this.#E){const t=this.#m-s;this.#E=setTimeout((()=>{this.#C=Date.now(),e.scheduleUpdate(this,this.#B),this.#E=null}),t)}}else e.scheduleUpdate(this,t)},t.subscribe(this.#v,this.#A))}#M(){this.#b?.abort(),this.#O&&clearTimeout(this.#O),this.#E&&clearTimeout(this.#E),this.#O=null,this.#E=null,this.#B=null;const t=ABind.#j(this.#d,!1);t&&this.#v&&this.#A&&t.unsubscribe(this.#v,this.#A),this.#v=null,this.#A=null}#R(t){if(!this.#a&&!this.#u||this.#h&&this.#g||this.#p)return;void 0===t&&(t=this.#u?this.#d.getAttribute(this.#u):ABind.#P(this.#d,this.#a));this.#l.split(",").map((t=>t.trim())).forEach((e=>this.#N(this.#f,e,t))),this.#g=!0}#L(t){let e;if(e=this.#u?this.#d.getAttribute(this.#u):ABind.#P(this.#d,this.#a),e==t)return;this.#u?this.#d.setAttribute(this.#u,t):this.#S(this.#d,this.#a,t);const i=ABind.#j(this.#d,!1),s=this.#a||this.#u;i&&s&&i.publish(s,t)}#U(t,e){switch(t){case"model":this.#d=e;break;case"property":this.#a=e;break;case"model-attr":this.#u=e;break;case"event":this.#n=e||"input";break;case"elem-attr":this.#l=e||"value";break;case"func":this.#o=e;break;case"throttle":this.#m=parseInt(e)||0;break;case"pull":this.#c=null!==e&&"false"!==e;break;case"push":this.#p=null!==e&&"false"!==e;break;case"once":this.#h=null!==e&&"false"!==e;break;case"debug":this.#r=null!==e&&"false"!==e}}static#j(e,i){return e&&"object"==typeof e?(!t.has(e)&&i&&t.set(e,new ModelObserver),t.get(e)||null):null}static#P(t,e){return e?e.split(".").reduce(((t,e)=>t&&t[e]),t):t}get model(){return this.#d}set model(t){this.#d=t,this.isConnected&&this.#T()}}class ABindgroup extends HTMLElement{static modelRegistry=new Map;static modelReferenceCounts=new Map;#F=null;#D=null;#V=null;async connectedCallback(){try{const t=this.getAttribute("model");if(!t)throw new Error('a-bindgroup requires "model" attribute.');const{modelInstance:e,modelUrl:i}=await this.#W(t);this.#F=i,this.#D=e;const s=ABindgroup.modelReferenceCounts.get(i)||0;ABindgroup.modelReferenceCounts.set(i,s+1),this.#$(),this.#V=new MutationObserver((t=>{let e=!1;for(const i of t)i.addedNodes.length>0&&(e=!0);e&&this.#$()})),this.#V.observe(this,{childList:!0,subtree:!0})}catch(t){console.error(t,this)}}disconnectedCallback(){if(this.#V?.disconnect(),this.#F){const t=ABindgroup.modelReferenceCounts.get(this.#F);1===t?(ABindgroup.modelRegistry.delete(this.#F),ABindgroup.modelReferenceCounts.delete(this.#F)):ABindgroup.modelReferenceCounts.set(this.#F,t-1)}}#$(){if(!this.#D)return;this.querySelectorAll("a-bind").forEach((t=>{t.model||(t.model=this.#D)}))}async#W(t){let e;return e=t.match(/\.(js|mjs)$/)||t.includes("/")?new URL(t,import.meta.url).href:new URL(`${t}.js`,import.meta.url).href,this.#H(e,t)}async#H(t,e){if(ABindgroup.modelRegistry.has(t))return{modelInstance:ABindgroup.modelRegistry.get(t),modelUrl:t};try{const e=await import(t);if("function"!=typeof e.default)throw new Error(`Module ${t} missing default class export.`);const i=new e.default;return ABindgroup.modelRegistry.set(t,i),{modelInstance:i,modelUrl:t}}catch(i){if(t.endsWith(".js")&&!e.endsWith(".js")){const i=t.replace(".js",".mjs");return this.#H(i,e)}throw i}}}customElements.get("a-bind")||customElements.define("a-bind",ABind),customElements.get("a-bindgroup")||customElements.define("a-bindgroup",ABindgroup);export{ABindgroup,ABind as default};
