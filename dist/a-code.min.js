class t extends HTMLElement{#t=new AbortController;#e;#i=!1;#n=!1;#s;#h=!1;#r=4;#o=!1;#l=0;#a=!1;#d="default";defaults={};static observedAttributes=["highlight","inline","indent","line-numbers","palette"];static template='\n    <style>\n      :host {\n        --indent: 1;\n        --line-number-color: gray;\n        --wrap: pre;\n        display: block;\n        max-width: 100%;\n        vertical-align: top;\n      }\n\n      :host([inline]) {\n        display: inline-block;\n        padding: 0;\n      }\n\n      section {\n        display: inline-grid;\n        gap: .5rem;\n        grid-template-columns: max-content 1fr;\n        width: 100%;\n      }\n\n      #content {\n        font-family: "Courier New", monospace;\n        tab-size: var(--indent);\n        white-space: var(--wrap);\n        overflow: auto;\n      }\n\n      #line-numbers {\n        color: var(--line-number-color);\n        font-family: monospace;\n        white-space: pre-line;\n      }\n    </style>\n\n    <section part="section">\n      <div id="line-numbers" part="line-numbers"></div>\n      <div id="content" part="content"><slot></slot></div>\n    </section>\n  ';constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=t.template}connectedCallback(){const t=this.shadowRoot.querySelector("slot");this.contentNode=this.shadowRoot.querySelector("#content"),this.textContent=this.resetSpaces(this.getContent()),this.highlight&&this.highlightCode(),this.lineNumbers&&this.addLineNumbers(),this.setDefaults(),t.addEventListener("slotchange",(()=>{this.updateIfNeeded()}),{signal:this.#t.signal})}attributeChangedCallback(t,e,i){this[t=t.replace(/-./g,(t=>t.toUpperCase()[1]))]=i}disconnectedCallback(){this.#t.abort(),this.#e.abort(),this.#t=null,this.#e=null}addLineNumbers(){let t=1;const e=this.shadowRoot.querySelector("#line-numbers");e.textContent="";const i=this.textContent.split(/\r?\n/).length,n=document.createElement("div");for(;t<=i;t++){const i=n.cloneNode();i.id="line-"+t,i.textContent=t,e.append(i)}}convertHTML(t){const e=document.createElement("textarea");return e.innerHTML=t,e.value}disableEdit(){this.contentNode.toggleAttribute("contentEditable",!1)}destroyHighlights(){try{return this.highlighter.removeAll()}catch(t){console.error(t)}}enableEdit(){this.contentNode.toggleAttribute("contentEditable",!0)}getContent(){return this.children[0]&&"textarea"===this.children[0].localName?this.textContent.replace("\\/","/"):this.convertHTML(this.innerHTML)}async highlightCode(t=this.highlight,e=this){try{return await this.highlighter.highlight(t,e.childNodes[0])}catch(t){throw t}}reset(){for(const t of ABind.observedAttributes)this[t]=this.defaults[t]}resetSpaces(t){this.needsUpdate=!1,t=t.replace(/^ +/gm,(t=>"\t".repeat(t.length))).trim();const e=t.split("\n"),i=e.at(-1).match(/^\s*/)[0].length,n=new RegExp(`^\\s{${i}}`,"g");return e.map((t=>t.replace(n,""))).join("\n")}setDefaults(){if(!(Object.keys(this.defaults).length>0))for(const e of t.observedAttributes)this.defaults[e]=this[e]}updateIfNeeded(t=this,e=500){const i=Date.now();this.#a?i-this.#l>e&&(this.#l=i,this.textContent=this.resetSpaces(this.getContent(t)),this.highlighter&&this.destroyHighlights(),this.lineNumbers&&this.addLineNumbers(),setTimeout((()=>{this.highlight&&this.highlightCode()}),50)):this.#a=!0}get inline(){return this.#h}set inline(t){switch(t=""!==t&&"false"!==t&&!1!==t){case"false":case!1:this.style.removeProperty("--wrap"),this.hasAttribute("line-numbers")&&(this.lineNumbers=this.getAttribute("line-numbers"));break;default:this.style.setProperty("--wrap","nowrap"),this.lineNumbers=!1}this.#h=t,window.abind&&abind.update(this,"inline",t)}get indent(){return this.#r}set indent(t){t||(t=this.defaults.indent),this.style.setProperty("--indent",t),this.#r=t,window.abind&&abind.update(this,"indent",t)}get highlight(){return this.#n}set highlight(t){switch(t){case"false":case!1:t=!1;break;case"":t="default";default:this.highlighter=this.highlighter||new e(this)}this.#n=t,this.contentNode&&this.updateIfNeeded(),window.abind&&abind.update(this,"inline",t)}get edit(){return this.#i}set edit(t){switch(t){case"false":case!1:this.#i=!1,this.contentNode&&this.disableEdit();break;default:this.#i=!0,this.contentNode?this.enableEdit():customElements.whenDefined(this.localName).then((t=>{this.enableEdit()}))}window.abind&&abind.update(this,"inline",this.#i)}get lineNumbers(){return this.#o}set lineNumbers(t){const e=this.shadowRoot.querySelector("#line-numbers");switch(t){case"false":case!1:this.#o=!1,e.textContent="";break;default:this.#o=!0,this.contentNode&&this.updateIfNeeded()}window.abind&&abind.update(this,"inline",this.#o)}get palette(){return this.#d}set palette(t){this.highlighter?(this.highlighter.palette="default"===t?"":t,window.abind&&abind.update(this,"inline",t)):console.error("highlighter has not been initialized")}}class e{#d;container;suffix="_"+Math.random().toString(36).substring(2,15);defaultColors=new Map([["argument","hsl(32, 93%, 66%)"],["comment","hsl(221, 12%, 69%)"],["function","hsl(210, 50%, 60%)"],["keyword","deeppink"],["number","hsl(32, 93%, 50%)"],["operator","red"],["property","orchid"],["string","hsl(114, 31%, 68%)"],["variable","darkkhaki"],["tag","indianred"]]);defaultSyntaxDef={argument:/(?<=\()[^)]+/g,function:/[\w-]+\s*\(|\)/g,operator:/[>+~*,*\/=]|(?<!\w[-])/g,property:/(?<!}[\r\n\s]+)\b([\w\d-]+:(?!:))/g,number:/(?<!\w)[#+-.]?\d+[%\b\.\w]*/g,tag:/<\/?[\w-]+|(?<=[\w"])>/g,string:/["'`][^"'`]*["'`]/g,variable:/--[\w\d]+-?[\w\d]*/g,comment:/(<!--|\/\*)([\s\S]*?)(-->|\*\/)/g,keyword:/@[\w]+\b/g};constructor(t,e){return this.container=t,this.palette=e,this}async highlight(t="html",e){if(void 0===window.Highlight)throw new Error("Browser does not support CSS Custom Highlight API");e=e||this.container.childNodes[0]||document.createTextNode("");const i=`highlights${this.suffix}`;document.head.querySelector(`#${i}`)||document.head.append(this.getStyle());try{const i=await this.getSyntax(t);return this.highlightCode(i,e),!0}catch(t){throw console.error("Error loading Highlight Syntax: ",t),t}}async getSyntax(t){if("default"===t||"html"===t)return this.defaultSyntaxDef;if("string"==typeof t){let e=t;/^(http|\.|\/)/.test(t)||(e=`./syntax.${t}.js`);try{t=await import(e)}catch(t){throw t}}return t.default}highlightCode(t={},e){if(e.nodeType!==Node.TEXT_NODE)throw new Error(`Second argument must be a TEXT_NODE (3). Given nodeType is (${e.nodeType})`);let i;const n=e.textContent;for(const s of Object.keys(t)){const h=t[s];if(h){if(Array.isArray(h)){const t=[...new Set(h)].join("|"),s=new RegExp(`\\b(${t})\\b`,"g");i=this.setRanges(s,n,e)}else if(h instanceof Function)i=new Set(h(n,e));else{if(!(h instanceof RegExp))throw console.error(`Invalid syntax definition for ${s}: `,`"${h}"`),new Error(`Invalid syntax definition for ${s}`);i=this.setRanges(h,n,e)}this.setHighlight(i,s)}}return!0}setRanges(t,e,i){const n=new Set,s=e.matchAll(t);for(const t of s){const e=t.index,s=e+t[0].length,h=new Range;h.setStart(i,e),h.setEnd(i,s),n.add(h)}return n}getHighlights(){const t=new Map;return CSS.highlights.forEach(((e,i)=>{i.endsWith(this.suffix)&&t.set(i,e)})),t}setHighlight(t,e="test"){e+=this.suffix;const i=new Highlight(...t);try{return CSS.highlights.set(e,i),!0}catch(t){throw t}}getStyle(){const t=document.createElement("style");let e="";return t.id=`highlights${this.suffix}`,this.palette.forEach(((t,i)=>{e+=`::highlight(${i}${this.suffix}) { color: ${t}}\n`})),t.textContent=e,t}remove(t){CSS.highlights.delete(t+this.suffix)}removeAll(){return CSS.highlights.forEach(((t,e)=>{e.endsWith(this.suffix)&&CSS.highlights.delete(e)})),this.suffix}clearRegistry(){CSS.highlights.clear()}logRegistry(){CSS.highlights.forEach(((t,e)=>{console.log(e,t)}))}get palette(){return this.#d||this.defaultColors}set palette(t){let e;const i=document.head.querySelector(`#highlights${this.suffix}`);if(t&&""!==t&&void 0!==t)if(Array.isArray(t))e=new Map(t);else if(t instanceof Map)e=t;else try{t=JSON.parse(t),e=new Map(t)}catch(t){console.error(t)}else this.#d=null;this.#d=e;const n=this.getStyle();i?document.head.replaceChild(n,i):document.head.append(n)}}document.addEventListener("DOMContentLoaded",(()=>{customElements.get("a-code")||customElements.define("a-code",t)}));export{t as ACode,e as Highlighter};
